version: "3.1"

# Rasa-style end-to-end conversation tests for the Ivy Gate B&B assistant.
#
# These stories describe the expected behaviour of the agent for the
# assignment scenarios, especially Scenario 1 (new booking) and
# Scenario 4 (things to do in Dalkey), as well as key robustness cases
# like negative guest counts and bookings in the past.

stories:
  - story: session_start_triggers_greeting
    description: Agent should proactively greet the caller when a new session starts.
    steps:
      # Special session_start intent triggers the pattern_session_start flow
      # which should immediately execute utter_greet.
      - intent: session_start
      - action: utter_greet

  - story: scenario1_new_booking_happy_path
    description: Fully successful new booking with availability check, total cost summary, confirmation, and DB write.
    steps:
      - user: |
          Hi, I'd like to book a room at Ivy Gate.
      - action: utter_greet

      # The assistant collects number of guests, stay dates, and guest name
      # via the make_booking flow. The exact prompts are generated by the
      # LLM based on the flow descriptions, so we assert only the key
      # custom actions rather than specific utterance texts.

      - user: |
          It will be 2 people from 2025-11-20 to 2025-11-22. My name is Alex.

      # Core availability lookup based on booking_number and booking_date.
      - action: action_get_matching_rooms

      # Caller picks one of the offered rooms and decides about breakfast.
      - user: |
          I'd like the sea view double room with breakfast included.

      # Booking is summarised with an approximate total price and a
      # clear confirmation question.
      - action: action_summarize_booking

      # Caller explicitly confirms they want to go ahead.
      - user: |
          Yes, please confirm this booking.

      # Final DB write into the bookings table and confirmation message
      # that includes the booking ID.
      - action: action_create_booking
      - action: utter_booking_complete

  - story: scenario1_negative_guest_count_graceful
    description: Booking for a negative number of guests is rejected gracefully and the agent reprompts.
    steps:
      - user: |
          I want to book a room for -2 people from 2025-11-20 to 2025-11-22.

      # The availability action validates guest count using normalize_guest_count
      # and should respond with a clear explanation and a reprompt rather than
      # crashing or proceeding.
      - action: action_get_matching_rooms

      # In a real conversation, the assistant would now ask again for a
      # valid positive number of guests and the flow would continue only
      # after that clarification.

  - story: scenario1_past_date_rejected
    description: Bookings that are entirely in the past are rejected and the agent asks for new dates.
    steps:
      - user: |
          I'd like to book a room for 2 people from 2020-01-01 to 2020-01-03.

      # action_get_matching_rooms checks that the requested stay is not
      # wholly in the past and should respond with a clarification message
      # asking for today or future dates.
      - action: action_get_matching_rooms

  - story: scenario4_dalkey_activities_standalone
    description: Caller without a booking asks about things to do in Dalkey.
    steps:
      - user: |
          What are some fun things to do in Dalkey?

      # pattern_search / pattern_chitchat flows route this to the
      # knowledge-style response template, which is then rephrased by
      # the NLG model. We assert the action, not the exact wording.
      - action: utter_free_chitchat_response

  - story: scenario4_dalkey_activities_during_booking
    description: While making a booking, the caller asks about things to do in Dalkey and the agent answers without breaking the flow.
    steps:
      - user: |
          Hi, I'd like to book a room.
      - action: utter_greet

      # Before providing all booking details, the caller diverts to ask
      # about local activities. This should be handled by the chitchat /
      # search patterns but must not break the main booking capability.
      - user: |
          While I'm staying, what can I do in Dalkey?
      - action: utter_free_chitchat_response

      # After answering, the agent should still be able to return to the
      # booking flow (not asserted here but implied by Scenario 1 tests).
